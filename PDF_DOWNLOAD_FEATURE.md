# Функция скачивания отчета о приеме в PDF

## Описание
Добавлена функциональность скачивания полной информации о приеме пациента в формате PDF.

## Что было реализовано

### 1. Backend (Python)

#### Новый модуль: `app/pdf_generator.py`
- Функция `generate_appointment_pdf()` для генерации PDF документа
- Использует библиотеку ReportLab
- Включает следующую информацию:
  - Информация о пациенте (ФИО, пол, возраст, МО прикрепления)
  - Хронические заболевания
  - Последние заболевания
  - Показатели здоровья (гемоглобин, холестерин, ИМТ, ЧСС)
  - Информация о приеме (дата, время, статус)
  - Медицинский отчет (цель обращения, жалобы, анамнез)
  - Статус отправки в МИС

#### Новый API endpoint: `GET /api/appointments/{appointment_id}/download-pdf`
- Расположен в `app/api/appointments.py`
- Возвращает PDF файл для скачивания
- Автоматически генерирует имя файла: `priem_{фамилия}_{дата}.pdf`
- Использует `StreamingResponse` для отправки файла

### 2. Frontend (JavaScript)

#### Изменения в `static/js/patient-card.js`
- Добавлен ID `download-pdf-btn` к кнопке "Скачать"
- Добавлен обработчик клика на кнопку
- Новый метод `downloadPDF()`:
  - Показывает индикатор загрузки
  - Выполняет запрос к API endpoint
  - Скачивает PDF файл через браузер
  - Показывает уведомление об успехе/ошибке

### 3. Зависимости

Добавлено в `requirements.txt`:
```
reportlab==4.2.5
```

## Как использовать

1. Откройте карточку любого приема
2. Нажмите кнопку "Скачать" в правом верхнем углу
3. PDF файл автоматически скачается в папку загрузок

## Формат PDF документа

PDF документ структурирован следующим образом:
- Заголовок: "Медицинский отчет о приеме"
- Разделы:
  - Информация о пациенте
  - Хронические заболевания
  - Последние заболевания
  - Показатели здоровья
  - Информация о приеме
  - Медицинский отчет (если заполнен)

## Технические детали

- PDF генерируется на лету при каждом запросе
- Размер документа: ~3-5 KB (в зависимости от объема данных)
- Кодировка: UTF-8 (поддержка кириллицы)
- Формат страницы: A4
- Поля: 2 см со всех сторон

## Тестирование

Функциональность протестирована:
- ✓ Генерация PDF с полными данными
- ✓ API endpoint возвращает корректный PDF
- ✓ Frontend корректно скачивает файл
- ✓ Имя файла формируется правильно
- ✓ Поддержка кириллицы в именах файлов (RFC 5987)
- ✓ Тестирование с несколькими пациентами (Иванов, Петрова)
- ✓ Уведомления об успешном скачивании работают корректно

## Исправленные ошибки

### UnicodeEncodeError при кириллице в имени файла
**Проблема**: При попытке скачать PDF получалась ошибка:
```
UnicodeEncodeError: 'latin-1' codec can't encode characters in position 27-32
```

**Причина**: HTTP заголовки должны быть в latin-1, но фамилия пациента с кириллицей не может быть закодирована в этой кодировке.

**Решение**: Использован RFC 5987 формат для заголовка Content-Disposition:
```python
Content-Disposition: attachment; filename=priem_20251016.pdf; filename*=UTF-8''priem_%D0%98%D0%B2%D0%B0%D0%BD%D0%BE%D0%B2_20251016.pdf
```

Это обеспечивает:
- Базовое ASCII имя файла для совместимости со старыми браузерами
- UTF-8 закодированное имя с кириллицей для современных браузеров

### Проблема с кириллицей внутри PDF

**Проблема**: Кириллица внутри PDF отображалась некорректно (вопросительные знаки, квадратики).

**Причина**: ReportLab по умолчанию использует шрифты Helvetica с кодировкой WinAnsiEncoding, которая не поддерживает кириллицу.

**Решение**: Встраивание TrueType шрифтов с поддержкой кириллицы:

1. Регистрация системных шрифтов Arial (поддерживают кириллицу):
```python
pdfmetrics.registerFont(TTFont('CustomFont', '/System/Library/Fonts/Supplemental/Arial.ttf'))
pdfmetrics.registerFont(TTFont('CustomFont-Bold', '/System/Library/Fonts/Supplemental/Arial Bold.ttf'))
```

2. Использование зарегистрированных шрифтов во всех стилях:
```python
title_style = ParagraphStyle('CustomTitle', fontName=FONT_NAME_BOLD, ...)
normal_style = ParagraphStyle('CustomNormal', fontName=FONT_NAME, ...)
```

3. Применение шрифтов в таблицах:
```python
TableStyle([
    ('FONTNAME', (0, 0), (0, -1), FONT_NAME_BOLD),
    ('FONTNAME', (1, 0), (1, -1), FONT_NAME),
    ...
])
```

**Результат**:
- PDF теперь корректно отображает кириллицу
- Размер файла увеличился с ~3KB до ~75KB из-за встроенных шрифтов
- Поддержка на всех платформах (macOS, Linux, Windows)


╔══════════════════════════════════════════════════════════════╗
║        РАЗВЕРТЫВАНИЕ ELIA PLATFORM НА UBUNTU СЕРВЕРЕ        ║
╚══════════════════════════════════════════════════════════════╝

🚀 БЫСТРЫЙ СТАРТ (автоматический)
────────────────────────────────────────────────────────────────
# 1. Подготовка сервера
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl wget git unzip

# 2. Запуск автоматического развертывания
wget https://raw.githubusercontent.com/ваш-репозиторий/main/scripts/deploy-ubuntu.sh
chmod +x deploy-ubuntu.sh
./deploy-ubuntu.sh -d example.com -k sk-ваш-ключ -e admin@example.com

📋 ТРЕБОВАНИЯ К СЕРВЕРУ
────────────────────────────────────────────────────────────────
- Ubuntu 20.04+ (рекомендуется 22.04 LTS)
- RAM: минимум 2GB (рекомендуется 4GB+)
- Диск: минимум 10GB свободного места
- CPU: минимум 1 ядро
- Сеть: открытые порты 80, 443

🔧 РУЧНАЯ УСТАНОВКА
────────────────────────────────────────────────────────────────
# 1. Установка Docker
sudo apt remove -y docker docker-engine docker.io containerd runc
sudo apt update
sudo apt install -y ca-certificates curl gnupg lsb-release
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo usermod -aG docker $USER
sudo systemctl enable docker
sudo systemctl start docker
newgrp docker

# 2. Подготовка проекта
sudo mkdir -p /opt/elia-platform
cd /opt/elia-platform
# Скопируйте файлы проекта сюда

# 3. Создание .env
cat > .env << 'EOF'
DATABASE_URL=sqlite+aiosqlite:///./data/elia.db
HOST=0.0.0.0
PORT=8000
DEBUG=false
OPENAI_API_KEY=ваш-ключ
OPENAI_MODEL=gpt-4
SECRET_KEY=$(openssl rand -hex 32)
DOMAIN=ваш-домен.com
EOF

# 4. Создание директорий
mkdir -p data logs static/uploads
chmod -R 755 data logs static/uploads

# 5. Сборка и запуск
docker compose build
docker compose up -d

🌐 НАСТРОЙКА NGINX
────────────────────────────────────────────────────────────────
# Установка Nginx
sudo apt install -y nginx

# Создание конфигурации
sudo nano /etc/nginx/sites-available/elia-platform
# (см. полную конфигурацию в UBUNTU_DEPLOYMENT.md)

# Активация
sudo ln -s /etc/nginx/sites-available/elia-platform /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl restart nginx

🔒 НАСТРОЙКА SSL
────────────────────────────────────────────────────────────────
# Установка Certbot
sudo apt install -y certbot python3-certbot-nginx

# Получение сертификата
sudo certbot --nginx -d ваш-домен.com

# Автообновление
sudo crontab -e
# Добавьте: 0 12 * * * /usr/bin/certbot renew --quiet

🔄 SYSTEMD СЕРВИС
────────────────────────────────────────────────────────────────
# Создание сервиса
sudo nano /etc/systemd/system/elia-platform.service
# (см. полную конфигурацию в UBUNTU_DEPLOYMENT.md)

# Активация
sudo systemctl daemon-reload
sudo systemctl enable elia-platform
sudo systemctl start elia-platform

🛡️ БЕЗОПАСНОСТЬ
────────────────────────────────────────────────────────────────
# Настройка файрвола
sudo apt install -y ufw
sudo ufw --force enable
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443

# Автообновления
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades

📊 МОНИТОРИНГ
────────────────────────────────────────────────────────────────
# Статус сервисов
sudo systemctl status elia-platform
sudo systemctl status nginx
sudo systemctl status docker

# Логи
docker compose logs -f
sudo journalctl -u elia-platform -f
sudo tail -f /var/log/nginx/elia-access.log

# Ресурсы
docker stats
htop
df -h

💾 БЭКАП
────────────────────────────────────────────────────────────────
# Создание скрипта бэкапа
sudo nano /opt/elia-platform/backup.sh
# (см. полный скрипт в UBUNTU_DEPLOYMENT.md)

# Ежедневный бэкап
sudo crontab -e
# Добавьте: 0 2 * * * /opt/elia-platform/backup.sh

🔄 ОБНОВЛЕНИЕ
────────────────────────────────────────────────────────────────
# Остановка сервиса
sudo systemctl stop elia-platform

# Обновление кода
cd /opt/elia-platform
git pull

# Пересборка
docker compose build

# Запуск
sudo systemctl start elia-platform

🐛 УСТРАНЕНИЕ НЕПОЛАДОК
────────────────────────────────────────────────────────────────
# Контейнер не запускается
docker compose logs
docker compose ps
docker compose config

# Nginx не работает
sudo nginx -t
sudo systemctl status nginx
sudo netstat -tlnp | grep 8000

# Нет доступа к сайту
sudo ufw status
sudo netstat -tlnp | grep -E ":(80|443|8000)"

# Проблемы с правами
sudo chown -R $USER:$USER /opt/elia-platform
sudo chmod -R 755 /opt/elia-platform/data /opt/elia-platform/logs

✅ ПРОВЕРКА РАБОТЫ
────────────────────────────────────────────────────────────────
# Статус сервисов
sudo systemctl status elia-platform nginx docker

# Health check
curl http://ваш-домен.com/health
curl https://ваш-домен.com/health

# Доступность сайта
curl -I http://ваш-домен.com
curl -I https://ваш-домен.com

# Открыть в браузере
open http://ваш-домен.com

📚 ПОЛЕЗНЫЕ КОМАНДЫ
────────────────────────────────────────────────────────────────
# Управление сервисом
sudo systemctl start elia-platform
sudo systemctl stop elia-platform
sudo systemctl restart elia-platform
sudo systemctl status elia-platform

# Управление Docker
docker compose up -d
docker compose down
docker compose restart
docker compose logs -f

# Управление Nginx
sudo systemctl restart nginx
sudo nginx -t
sudo systemctl reload nginx

# Мониторинг
docker stats
sudo htop
df -h
free -h

📁 СТРУКТУРА ФАЙЛОВ НА СЕРВЕРЕ
────────────────────────────────────────────────────────────────
/opt/elia-platform/          # Основная директория проекта
├── .env                     # Конфигурация
├── docker-compose.yml       # Docker Compose конфигурация
├── Dockerfile               # Docker образ
├── app/                     # Код приложения
├── static/                  # Статические файлы
├── templates/               # HTML шаблоны
├── data/                    # База данных
├── logs/                    # Логи приложения
├── static/uploads/          # Загруженные файлы
└── backup.sh               # Скрипт бэкапа

/etc/nginx/sites-available/elia-platform  # Конфигурация Nginx
/etc/systemd/system/elia-platform.service # Systemd сервис
/opt/backups/elia-platform/               # Бэкапы

⚠️ ВАЖНЫЕ МОМЕНТЫ
────────────────────────────────────────────────────────────────
✅ Все данные хранятся в /opt/elia-platform/ (персистентно)
✅ Бэкапы создаются автоматически каждый день в 2:00
✅ SSL сертификаты обновляются автоматически
✅ Приложение запускается автоматически при перезагрузке сервера
✅ Файрвол настроен и защищает сервер
✅ Логи доступны для мониторинга

❌ НЕ ДЕЛАЙТЕ:
- Не запускайте скрипты от root
- Не удаляйте папку /opt/elia-platform/data/
- Не отключайте файрвол без необходимости
- Не забывайте обновлять систему

📖 ДОКУМЕНТАЦИЯ
────────────────────────────────────────────────────────────────
UBUNTU_DEPLOYMENT.md        # Полное руководство по развертыванию
scripts/deploy-ubuntu.sh     # Автоматический скрипт развертывания
env.production.example       # Пример продакшн конфигурации

═══════════════════════════════════════════════════════════════


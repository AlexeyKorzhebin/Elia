# Скрипты управления сервером

Набор скриптов для удобного управления Elia Platform на удаленном сервере.

## Предварительные требования

- Настроенный SSH доступ по ключам (см. `SSH_SETUP.md`)
- Сервер: `root@43.245.224.114`
- Установленный Docker и Docker Compose на сервере

## Доступные скрипты

### 1. `server-status.sh` - Проверка статуса

Показывает полную информацию о состоянии сервера и приложения.

```bash
./scripts/server-status.sh
```

**Отображает:**
- Информацию о сервере (hostname, uptime)
- Статус Docker контейнера
- Здоровье приложения (health check)
- Использование ресурсов (CPU, память)
- Размер базы данных
- Последние 10 строк логов

**Пример использования:**
```bash
cd /Users/aleksey.korzhebin/Yandex.Disk.localized/Projects/Research/Elia
./scripts/server-status.sh
```

---

### 2. `server-logs.sh` - Просмотр логов

Показывает логи приложения в реальном времени.

```bash
./scripts/server-logs.sh [количество_строк]
```

**Параметры:**
- `количество_строк` - сколько последних строк показать (по умолчанию: 100)

**Примеры использования:**
```bash
# Показать последние 100 строк и следить за новыми
./scripts/server-logs.sh

# Показать последние 50 строк
./scripts/server-logs.sh 50

# Показать последние 500 строк
./scripts/server-logs.sh 500
```

**Остановить просмотр:** `Ctrl+C`

---

### 3. `server-restart.sh` - Перезапуск приложения

Останавливает и запускает приложение заново.

```bash
./scripts/server-restart.sh
```

**Что делает:**
1. Останавливает текущий контейнер
2. Запускает контейнер заново
3. Проверяет работоспособность
4. Показывает статус

**Когда использовать:**
- После изменения конфигурации
- При зависании приложения
- После изменения файла `.env`

---

### 4. `server-resources.sh` - Мониторинг ресурсов

Показывает подробную информацию об использовании ресурсов на сервере.

```bash
./scripts/server-resources.sh
```

**Что показывает:**
- Использование CPU и памяти Docker контейнером
- Основной процесс и его ресурсы
- Общая память системы
- Использование диска
- Размер базы данных
- Загрузка системы (load average)
- Сетевая активность
- Время работы
- Здоровье приложения

**Когда использовать:**
- Для проверки производительности
- При диагностике проблем
- Для планирования масштабирования
- Регулярный мониторинг

---

### 5. `update-server.sh` - Обновление приложения

Обновляет приложение до последней версии из Docker Hub.

```bash
./scripts/update-server.sh
```

**Что делает:**
1. Проверяет подключение к серверу
2. Загружает новый Docker образ
3. Останавливает старый контейнер
4. Запускает обновленный контейнер
5. Проверяет работоспособность

**Когда использовать:**
- После публикации новой версии на Docker Hub
- При обновлении функционала
- При исправлении ошибок

---

### 6. `setup-docker.sh` - Настройка Docker окружения

Автоматически настраивает Docker окружение для работы с проектом.

```bash
./scripts/setup-docker.sh
```

**Что делает:**
- Проверяет установку Docker и Docker Compose
- Создаёт необходимые директории
- Настраивает права доступа
- Проверяет конфигурацию

**Когда использовать:**
- При первом запуске проекта
- После переустановки Docker
- При проблемах с правами доступа

---

### 7. `build-and-push.sh` - Сборка и публикация

Собирает Docker образ и публикует на Docker Hub.

```bash
./scripts/build-and-push.sh [опции]
```

**Опции:**
- `-u, --username USERNAME` - Docker Hub username (по умолчанию: alekseykorzhebin)
- `-i, --image IMAGE` - название образа (по умолчанию: elia-platform)
- `-v, --version VERSION` - версия (по умолчанию: 1.0.0)
- `-f, --file DOCKERFILE` - Dockerfile (по умолчанию: Dockerfile.production)
- `-a, --build-arg KEY=VALUE` - аргументы сборки
- `-h, --help` - справка

**Примеры:**
```bash
# Собрать с настройками по умолчанию
./scripts/build-and-push.sh

# Собрать версию 1.0.2
./scripts/build-and-push.sh -v 1.0.2

# Собрать с другим Dockerfile
./scripts/build-and-push.sh -f Dockerfile.simple
```

---

## Типичные сценарии использования

### Проверить состояние сервера

```bash
./scripts/server-status.sh
```

### Просмотреть ошибки в логах

```bash
./scripts/server-logs.sh 200 | grep ERROR
```

### Обновить приложение на сервере

```bash
# 1. Собрать и опубликовать новую версию
./scripts/build-and-push.sh

# 2. Обновить на сервере
./scripts/update-server.sh

# 3. Проверить что все работает
./scripts/server-status.sh
```

### Перезапустить после изменения .env

```bash
# 1. Скопировать новый .env на сервер
scp .env root@43.245.224.114:/opt/elia-platform/.env

# 2. Перезапустить приложение
./scripts/server-restart.sh
```

### Мониторинг в реальном времени

```bash
# В одном терминале
./scripts/server-logs.sh

# В другом терминале
watch -n 5 ./scripts/server-status.sh
```

---

## Прямые SSH команды

Если нужно выполнить специфичную команду:

```bash
# Выполнить команду
ssh root@43.245.224.114 "команда"

# Примеры
ssh root@43.245.224.114 "docker ps"
ssh root@43.245.224.114 "cd /opt/elia-platform && docker compose logs --tail=50"
ssh root@43.245.224.114 "df -h"
ssh root@43.245.224.114 "free -h"
```

---

## Управление базой данных

### Скачать базу данных с сервера

```bash
scp root@43.245.224.114:/opt/elia-platform/elia.db ./backup/elia-$(date +%Y%m%d).db
```

### Загрузить базу данных на сервер

```bash
# 1. Остановить контейнер
./scripts/server-restart.sh

# 2. Загрузить базу
scp ./elia.db root@43.245.224.114:/opt/elia-platform/elia.db

# 3. Установить правильные права
ssh root@43.245.224.114 "chown 999:999 /opt/elia-platform/elia.db && chmod 664 /opt/elia-platform/elia.db"

# 4. Запустить контейнер
./scripts/server-restart.sh
```

---

## Устранение неполадок

### Скрипт не запускается

```bash
# Проверить права
ls -la scripts/

# Сделать исполняемым
chmod +x scripts/*.sh
```

### Скрипт запрашивает пароль

Проверьте SSH ключи:
```bash
ssh -v root@43.245.224.114
```

См. документацию в `SSH_SETUP.md`.

### Контейнер не запускается

```bash
# Посмотреть подробные логи
./scripts/server-logs.sh 200

# Проверить на сервере вручную
ssh root@43.245.224.114
cd /opt/elia-platform
docker compose logs
docker compose ps
```

---

## Безопасность

⚠️ **Важно:**
- Скрипты содержат адрес сервера в коде
- Не публикуйте скрипты с реальными адресами в открытых репозиториях
- Храните резервные копии SSH ключей в безопасном месте
- Регулярно делайте backup базы данных

---

## Дополнительные ресурсы

- `SSH_SETUP.md` - настройка SSH доступа
- `DOCKER_HUB_GUIDE.md` - работа с Docker Hub
- `DEPLOYMENT_SUCCESS.md` - информация о деплое
- `README.md` - общая документация проекта


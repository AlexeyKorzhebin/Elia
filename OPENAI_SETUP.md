# Настройка OpenAI API для генерации mock-разговоров

## Обзор

Функциональность генерации mock-разговоров использует OpenAI API для:
1. Генерации реалистичных диалогов врач-пациент с временными метками
2. Автоматического извлечения структурированных данных для анамнеза

## Настройка

### 1. Получение API ключа

Вам нужен API ключ от совместимого с OpenAI провайдера:
- OpenAI (https://platform.openai.com/)
- Azure OpenAI
- Другие OpenAI-совместимые провайдеры

### 2. Создание .env файла

Создайте файл `.env` в корне проекта на основе `.env.example`:

```bash
cp .env.example .env
```

### 3. Заполнение конфигурации

Откройте `.env` и настройте следующие параметры:

```env
# OpenAI API Configuration
OPENAI_API_KEY=your-api-key-here          # Ваш API ключ
OPENAI_BASE_URL=https://api.openai.com/v1 # URL провайдера
OPENAI_MODEL=gpt-4                         # Модель для использования
```

#### Параметры:

- **OPENAI_API_KEY**: API ключ от вашего провайдера (обязательно)
- **OPENAI_BASE_URL**: URL endpoint API (по умолчанию OpenAI)
- **OPENAI_MODEL**: Модель для использования (рекомендуется `gpt-4` или `gpt-3.5-turbo`)

### 4. Установка зависимостей

Убедитесь, что установлена библиотека OpenAI:

```bash
pip install -r requirements.txt
```

### 5. Перезапуск приложения

После настройки перезапустите приложение:

```bash
uvicorn app.main:app --reload
```

## Использование

### На странице карточки пациента:

1. Перейдите на вкладку **"Стенограмма"**
2. Нажмите кнопку **"Сгенерировать разговор (AI)"**
3. Дождитесь генерации диалога (обычно 5-15 секунд)
4. Просмотрите сгенерированную транскрипцию
5. Нажмите **"Извлечь анамнез из разговора"**
6. Данные будут автоматически заполнены в разделе "Анамнез"

## Примеры конфигурации

### OpenAI

```env
OPENAI_API_KEY=sk-proj-...
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4
```

### Azure OpenAI

```env
OPENAI_API_KEY=your-azure-key
OPENAI_BASE_URL=https://your-resource.openai.azure.com/openai/deployments/your-deployment
OPENAI_MODEL=gpt-4
```

### Другие провайдеры

Любой OpenAI-совместимый провайдер с поддержкой Chat Completions API:

```env
OPENAI_API_KEY=your-key
OPENAI_BASE_URL=https://your-provider-url/v1
OPENAI_MODEL=model-name
```

## Стоимость

Приблизительная стоимость за один запрос:

- **Генерация разговора**: ~1500-2000 tokens (вход + выход)
- **Извлечение анамнеза**: ~1000-1500 tokens (вход + выход)

**Итого на один полный цикл**: ~2500-3500 tokens

Для `gpt-4`:
- Входящие tokens: ~$0.03 / 1K tokens
- Исходящие tokens: ~$0.06 / 1K tokens
- **Примерная стоимость за цикл**: ~$0.10-0.15

Для `gpt-3.5-turbo`:
- Входящие tokens: ~$0.0015 / 1K tokens  
- Исходящие tokens: ~$0.002 / 1K tokens
- **Примерная стоимость за цикл**: ~$0.005-0.01

## Безопасность

⚠️ **Важно**:
- Никогда не коммитьте `.env` файл в git
- `.env` уже добавлен в `.gitignore`
- Держите API ключи в секрете
- Используйте переменные окружения в production

## Troubleshooting

### Ошибка: "OpenAI API key не настроен"

Проверьте:
1. Файл `.env` существует в корне проекта
2. `OPENAI_API_KEY` заполнен корректно
3. Приложение перезапущено после создания `.env`

### Ошибка генерации разговора

Проверьте:
1. API ключ действителен
2. URL провайдера корректен
3. Модель доступна для вашего аккаунта
4. Баланс API ключа положительный

### Долгая генерация

- Нормальное время генерации: 5-15 секунд
- При первом запросе может быть дольше
- Проверьте качество интернет-соединения

## Логи

Все операции логируются в:
- `logs/elia-app-{date}.log` - общие логи приложения
- `logs/elia-errors-{date}.log` - ошибки

Для отладки включите DEBUG режим:

```env
LOG_LEVEL=DEBUG
```

## Поддержка

При возникновении проблем проверьте логи и обратитесь к документации OpenAI API:
https://platform.openai.com/docs/api-reference


# Исправление: Исчезновение транскрипции при переключении вкладок

## Проблема

После генерации разговора, сохранения изменений и переключения между вкладками "Анамнез" и "Стенограмма" - транскрипция исчезала при возврате на вкладку "Стенограмма".

## Причина

При каждом переключении на вкладку "Стенограмма" вызывался метод `AudioHandler.init()`, который:
1. Сбрасывал флаг `hasGeneratedConversation = false`
2. Сбрасывал флаг инициализации
3. Заново загружал UI, создавая race condition

Это приводило к тому, что даже при наличии сохраненной транскрипции в БД, она не отображалась или отображался пустой UI.

## Решение

Добавлен механизм кэширования состояния:

### 1. Новый флаг `isInitialized`

```javascript
const AudioHandler = {
    appointmentId: null,
    audioData: null,
    hasGeneratedConversation: false,
    isInitialized: false,  // ← Новый флаг
```

### 2. Проверка при инициализации

```javascript
init(appointmentId) {
    // Если уже инициализирован для этого приёма, не перезапускаем
    if (this.appointmentId === appointmentId && this.isInitialized) {
        console.log('AudioHandler уже инициализирован для этого приёма');
        return;
    }
    
    this.appointmentId = appointmentId;
    this.hasGeneratedConversation = false;
    this.isInitialized = false;
    this.checkExistingAudio();
}
```

### 3. Установка флага после загрузки

```javascript
// При успешной загрузке из БД
if (audioData.transcription_text && audioData.transcription_status === 'COMPLETED') {
    this.isInitialized = true;
    this.hasGeneratedConversation = true;
    this.displayEditableTranscription(audioData.transcription_text, audioData.id);
    return;
}

// При генерации нового разговора
this.hasGeneratedConversation = true;
this.isInitialized = true;
```

### 4. Обновление данных при сохранении

```javascript
// Обновляем данные в audioData после сохранения
if (this.audioData) {
    this.audioData.transcription_text = text;
}
```

## Workflow после исправления

```
1. Пользователь генерирует разговор
   → isInitialized = true, audioData сохраняется
   
2. Переключается на вкладку "Анамнез"
   → Контент вкладки меняется
   
3. Переключается обратно на "Стенограмма"
   → init() проверяет: appointmentId тот же И isInitialized = true
   → НЕ перезагружает контент, просто выходит
   → Транскрипция остаётся на месте ✅
   
4. Переключается на другой приём
   → appointmentId меняется
   → init() запускает полную инициализацию заново
```

## Преимущества

✅ **Стабильность**: Контент не исчезает при переключении вкладок
✅ **Производительность**: Нет повторных запросов к API при переключении
✅ **UX**: Плавная работа без мерцания контента
✅ **Кэширование**: Данные сохраняются в памяти браузера

## Тестирование

### Сценарий теста:
1. Открыть приём пациента
2. Перейти на вкладку "Стенограмма"
3. Нажать "Сгенерировать разговор (AI)"
4. Дождаться генерации
5. Внести изменения в текст
6. Нажать "Сохранить изменения"
7. Переключиться на вкладку "Анамнез"
8. Вернуться на вкладку "Стенограмма"

### Ожидаемый результат:
- ✅ Транскрипция отображается
- ✅ Все изменения сохранены
- ✅ Можно продолжить редактирование
- ✅ Кнопки "Сохранить" и "Извлечь анамнез" доступны

## Файлы изменены

- `static/js/audio-handler.js` - основная логика исправления

## Дата исправления

26 октября 2025

